name: build

on:
  workflow_dispatch:
    inputs:
      repo_url:
        required: true
        type: string
      repo_pkg:
        required: true
        type: string
      makepkgArgs:
        type: string
      multilib:
        type: boolean
        default: false
      nvidiaUtils:
        type: boolean
        default: false
      arch:
        type: string
        default: alderlake
      svn:
        type: boolean
        default: false

jobs:
  package: 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Clone Package
        run: |
          if ${{ inputs.svn }}; then
            source functions.sh && git-svn ${{ inputs.repo_url }} aur/${{ inputs.repo_pkg }}
            source functions.sh && echo "sum=$(genLocalSum ${{ inputs.repo_pkg }})" >> $GITHUB_OUTPUT
            source functions.sh && echo $(checkLocalVersion ${{ inputs.repo_pkg }}) >> $GITHUB_OUTPUT
          else
            git clone ${{ inputs.repo_url }}/${{ inputs.repo_pkg }}.git
          fi
      - name: Set PKGBUILD architecture 
        run: |
          if [[ ${{ inputs.arch }} != 'generic_x86_64' ]]; then
            source functions.sh && setArch ${{ inputs.arch }} ${{ inputs.repo_pkg }}/PKGBUILD
          fi
          cat ${{ inputs.repo_pkg }}/PKGBUILD
      - name: Makepkg Build and Check
        id: makepkg
        uses: highkeep/pkgbuild-action@master
        with:
          pkgdir: ${{ inputs.repo_pkg }}
          pacmanConf: "configs/${{ inputs.arch }}_pacman.conf"
          makepkgConf: "configs/${{ inputs.arch }}_makepkg.conf"
          makepkgArgs: ${{ inputs.makepkgArgs }}
          multilib: ${{ inputs.multilib }}
          nvidiaUtils: ${{ inputs.nvidiaUtils }}